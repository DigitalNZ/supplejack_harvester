<%= content_for(:title) { @pipeline.name_in_database } %>
<%= content_for(:header) do %>
  <%= render "shared/breadcrumb_nav" %>

  <div class='float-start'>
    <h1><%= @pipeline.name %></h1>
    <p><%= @pipeline.description %></p>
  </div>

  <div class='clearfix'></div>

  <div class='mt-4'></div>
  <ul class="nav nav-tabs">
    <li class='nav-item'>
      <%= link_to "Pipeline", pipeline_path(@pipeline), class: "nav-link" %>
    </li>

    <li class='nav-item'>
      <%= link_to "Jobs", pipeline_pipeline_jobs_path(@pipeline), class: "nav-link active" %>
    </li>
  </ul>
<% end %>

<div class='card'>
  <table class="table table-borderless table--jobs">
    <thead>
      <tr class='table-primary'>
        <th scope="col">Pipeline jobs</th>
        <th scope="col">Status</th>
        <th scope="col">Job started</th>
        <th scope="col">Duration</th>
        <th scope="col">Pages Extracted</th>
        <th scope="col">Records Transformed</th>
        <th scope="col">Records Loaded</th>
        <th scope="col">Records Rejected</th>
        <th scope="col">Records Deleted</th>
        <th scope="col"></th>
      </tr>
    </thead>
    <tbody>
      <% @pipeline_jobs.each.with_index(1) do |pipeline_job, index| %>
        <% next if pipeline_job.harvest_reports.empty? %>
          <% pipeline_job.harvest_reports.each do |report| %>

            <% badge_classes = class_names(
                'badge', 
                { 
                  'bg-primary': report.status == 'completed', 
                  'bg-secondary': report.status == 'running' || report.status == 'queued'
                }
            ) %>
            
            <tr>
              <td><%= report.harvest_job.name %></td>
              <td>
                <span class="<%= badge_classes %>">
                  <%= report.status.capitalize %>
                </span>
              </td>
              <td><%= pipeline_job.start_time.strftime('%H:%M %d/%m/%y') %></td>
              <td><%= job_duration_seconds(report.duration_seconds) %></td>
              <td><%= report.pages_extracted %></td>
              <td><%= report.records_transformed %></td>
              <td><%= report.records_loaded %></td>
              <td><%= report.records_rejected %></td>
              <td><%= report.records_deleted %></td>
              <td>
                <i class="bi bi-three-dots-vertical" data-bs-toggle='dropdown'></i>
                <ul class="dropdown-menu dropdown-menu-end">
                  <% if report.harvest_job.extraction_job_id.present? %>
                    <li>
                      <%= link_to pipeline_harvest_definition_extraction_definition_extraction_job_path(@pipeline.id, report.harvest_definition.id, report.extraction_definition.id, report.harvest_job.extraction_job_id), class: 'dropdown-item card__control-action' do %>
                        <i class="bi bi-link-45deg me-2"></i>View Extracted Data
                      <% end %>
                    </li>
                  <% end %>
                </ul>
              </td>
            </tr>
          <% end %>

        <% if index != (@pipeline_jobs.count) %>
          <tr class='table__divider'>
            <td colspan='10'>
              <hr />
            </td>
          </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>
</div>

<%= render 'shared/pagination_below_table', items: @pipeline_jobs %>

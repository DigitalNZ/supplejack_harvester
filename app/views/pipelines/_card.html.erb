<% jobs_path ||= ''
   run_sample_extraction_path ||= ''
   run_full_extraction_path ||= ''
   type = definition.class.name.gsub(/Definition$/, '').downcase
   position = type == 'extraction' ? 'first' : 'last' %>

<div class="card">
  <div class='card-body'>
    <h5 class="card-title"><%= definition.name %></h5>

    <% if reference?(pipeline, definition) %>
      <span class="badge text-bg-light">Reference</span>
    <% end %>

    <div class="btn-group card__control">
      <i class="bi bi-three-dots-vertical" data-bs-toggle='dropdown'></i>
      <ul class="dropdown-menu dropdown-menu-end">
        <% if reference?(pipeline, definition) %>
          <li>
            <%= link_to edit_path, class: 'dropdown-item card__control-action' do %>
              <i class="bi bi-link-45deg me-2"></i>Go to reference source
            <% end %>
          </li>
          <li><hr class="dropdown-divider"></li>
        <% else %>
          <li>
            <%= link_to edit_path, class: 'dropdown-item card__control-action' do %>
              <i class="bi bi-link-45deg me-2"></i><%= edit_text %>
            <% end %>
          </li>
        <% end %>

        <% if reference?(pipeline, definition) %>
          <li>
            <a
              class="dropdown-item card__control-action"
              href="#"
              data-bs-toggle='modal'
              data-bs-target="<%= "#remove-reference-#{definition.id}" %>">
                <i class="bi bi-trash me-2"></i>Remove definition
              </a>
          </li>
        <% end %>

        <% if jobs_path.present? %>
          <li>
            <%= link_to jobs_path, class: 'dropdown-item card__control-action' do %>
              <i class="bi bi-eye me-2"></i> View Extraction Jobs
            <% end %>
          </li>
        <% end %>

        <% if run_sample_extraction_path.present? %>
          <li>
            <%= button_to run_sample_extraction_path, class: 'dropdown-item card__control-action' do %>
              <i class="bi bi-play me-2"></i> Run Sample Extraction
            <% end %>
          </li>
        <% end %>

        <% if run_full_extraction_path.present? %>
          <li>
            <%= button_to run_full_extraction_path, class: 'dropdown-item card__control-action' do %>
              <i class="bi bi-play me-2"></i> Run Full Extraction
            <% end %>
          </li>
        <% end %>
      </ul>
    </div>
  </div>

  <% if position == 'first' %>
    <i class="bi bi-arrow-right card__right-arrow"></i>
  <% end %>
</div>

<div
  class="modal fade"
  id="<%= "remove-reference-#{definition.id}" %>">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Remove reference</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to remove this reference?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <%= button_to 'Remove', pipeline_harvest_definition_path(@pipeline, block_definition),
                      params: {
                        harvest_definition: {
                          "#{type}_definition_id": nil
                        }
                      },
                      method: :patch,
                      class: 'btn btn-danger' %>
      </div>
    </div>
  </div>
</div>

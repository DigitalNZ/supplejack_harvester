<%= content_for(:title) { @pipeline.name_in_database } %>
<%= content_for(:header) do %>
  <%= render 'shared/breadcrumb_nav' %>

  <div class='float-start'>

    <%= render layout: 'shared/inline_editable_element', locals: { id: 'pipeline-name', model: @pipeline, url: pipeline_path(@pipeline), attribute: :name } do %>
      <h1><%= @pipeline.name %></h1>
    <% end %>

    <%= render layout: 'shared/inline_editable_element', locals: { id: 'pipeline-description', model: @pipeline, url: pipeline_path(@pipeline), attribute: :description } do %>
      <p><%= @pipeline.description %></p>
    <% end %>
  </div>

  <div class="float-end">
      <%= button_tag(
            type: 'button',
            class: 'btn btn-primary me-1',
            disabled: !@pipeline.ready_to_run?,
            data: { 'bs-toggle' => 'modal', 'bs-target' => '#run-settings' }
          ) do %>
      <i class='bi bi-play'></i>
        Run
    <% end %>

    <% if @pipeline.ready_to_run? %>
      <%= render layout: 'shared/create_modal', locals: { modal_heading: 'Run Settings', id: 'run-settings' } do %>
        <%= vertical_form_with(model: [@pipeline, @pipeline_job]) do |form| %>
          <div class='row gy-3 align-items-center'>
            <%= form.hidden_field :pipeline_id, value: @pipeline.id %>
            <%= form.hidden_field :key, value: SecureRandom.hex %>

            <div class='col-5'>
              <%= form.label :harvest_definitions_to_run, 'Blocks to run', class: 'form-label' %>
            </div>

            <div class='col-7'>
              <%- @pipeline.harvest_definitions.each do |harvest_definition| %>
                <div class='form-check'>
                  <%= label_tag do %>

                    <%= check_box('pipeline_job', 'harvest_definitions_to_run', {
                                    multiple: true,
                                    checked: harvest_definition.ready_to_run?,
                                    class: "form-check-input js-pipeline-#{harvest_definition.kind}-checkbox",
                                    disabled: !harvest_definition.ready_to_run?
                                  }, harvest_definition.id, nil) %>

                    <%= harvest_definition.source_id %>
                  <% end %>
                </div>
              <% end %>
            </div>

            <% if @extraction_jobs %>
              <div class="col-5 js-transformation-input">
                <%= form.label :extraction_job_id, 'Transformation input', class: 'form-label' %>
              </div>

              <div class='col-7 js-transformation-input'>
                <%= form.collection_select(:extraction_job_id, @extraction_jobs, :id, :name,
                                           { include_blank: 'Fresh extraction' }, class: 'form-select') %>
              </div>
            <% end %>

            <div class="col-5">
              <%= form.label :page_type, 'Pages to transform', class: 'form-label' %>
            </div>

            <div id='js-pipeline-page-type' class='col-7'>
              <%= form.select :page_type, options_for_select(
                    PipelineJob.page_types.map do |key, _value|
                      [key.humanize, key]
                    end
                  ), {}, id: 'js-pipeline-page-type-select', class: 'form-select' %>
            </div>

            <div id='js-pipeline-pages' class='col-3 d-none'>
              <%= form.number_field :pages, class: 'form-control' %>
            </div>

            <div class="col-5">
              <%= form.label :destination, 'Destination', class: 'form-label' %>
            </div>

            <div class='col-7'>
              <%= form.select :destination_id, options_from_collection_for_select(@destinations, 'id', 'name'), {},
                              class: 'form-select' %>
            </div>
          </div>

          <div class='d-grid mt-4'>
            <button type="submit" class="btn btn-primary">Run</button>
          </div>
        <% end %>
      <% end %>
    <% end %>

    <button
      type="button"
      class="btn btn-outline-primary"
      data-bs-toggle="modal"
      data-bs-target="#clone-pipeline">
      <i class="bi bi-layers" aria-hidden="true"></i> Clone pipeline
    </button>

    <div
      class="modal fade"
      id="clone-pipeline">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Clone and edit new pipeline</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Please name the new pipeline which you are cloning</p>

            <%= vertical_form_with(model: @pipeline,
                                   url: clone_pipeline_path(@pipeline), method: :post) do |f| %>

              <%= f.text_field :name, required: true, class: 'form-control', value: "[CLONE] #{@pipeline.name}" %>

              <br>

              <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Clone and edit new</button>

            <% end %>
          </div>
        </div>
      </div>
    </div>

    <button
      type="button"
      class="btn btn-danger ms-1"
      data-bs-toggle="modal"
      data-bs-target="#delete-modal">
      <i class="bi bi-trash" aria-hidden="true"></i> Delete
    </button>
  </div>

  <div class='clearfix'></div>

  <div class='mt-4'></div>
  <ul class="nav nav-tabs">
    <li class='nav-item'>
      <%= link_to 'Pipeline', pipeline_path(@pipeline), class: 'nav-link active' %>
    </li>

    <li class='nav-item'>
      <%= link_to "Schedules (#{@pipeline.schedules.count})", pipeline_schedules_path(@pipeline), class: 'nav-link' %>
    </li>

    <li class='nav-item'>
      <%= link_to 'Jobs', pipeline_pipeline_jobs_path(@pipeline), class: 'nav-link' %>
    </li>
  </ul>
<% end %>

<% if @pipeline.harvest.blank? %>
  <div class='row definition-group'>
    <div class='col-12'>
      <button
        type="button"
        class="card card--create-cta d-flex"
        data-bs-toggle="modal"
        data-bs-target="#add-harvest">
        <div class="card-body align-items-center d-flex justify-content-center">
          <p class='card-text'>+ Add harvest</p>
        </div>
      </button>
    </div>
  </div>
<% else %>
  <div class='card p-4'>
    <div class='d-flex'>
      <div class='me-auto'>

        <%= render layout: 'shared/inline_editable_element', locals: { id: "harvest-definition-#{@harvest_definition.id}-source-id", model: @harvest_definition, attribute: :source_id, url: pipeline_harvest_definition_path(@pipeline, @harvest_definition) } do %>
          <h4><%= @harvest_definition.source_id %> </h4>
        <% end %>
        
        <p><%= definition_help_text(@harvest_definition, 'harvest') %></p>
      </div>

      <div>
        <button
          type="button"
          class="btn btn-outline-danger"
          data-bs-toggle="modal"
          data-bs-target="<%= "#delete-harvest-definition-#{@harvest_definition.id}" %>">
          <i class="bi bi-trash" aria-hidden="true"></i> Delete Harvest
        </button>
      </div>

      <% if @harvest_definition.persisted? %>
        <%= render layout: 'shared/delete_modal',
                   locals: { path: pipeline_harvest_definition_path(@pipeline, @harvest_definition),
                             id: "delete-harvest-definition-#{@harvest_definition.id}", heading_text: 'Delete Harvest' } do %>
          <p>Are you sure you want to delete "<%= @harvest_definition.source_id %>"?</p>

          <% if @harvest_definition.extraction_definition.present? %>
            <p><%= definition_delete_text(@harvest_definition.extraction_definition, 'extraction') %></p>
          <% end %>

          <% if @harvest_definition.transformation_definition.present? %>
            <p><%= definition_delete_text(@harvest_definition.transformation_definition, 'transformation') %></p>
          <% end %>
        <% end %>
      <% end %>
    </div>

    <input
      type='hidden'
      value="<%= @pipeline.id %>"
      name='pipeline_id'
      id='js-pipeline-id'>
    <input
      type='hidden'
      value="<%= @pipeline.harvest.id %>"
      name='harvest_id'
      id='js-harvest-definition-id'>

    <div class='row'>
      <div class='col-6'>
        <% if @harvest_definition.extraction_definition.present? %>

          <%= render partial: 'pipelines/card',
                     locals: {
                       pipeline: @pipeline,
                       block_definition: @harvest_definition,
                       definition: @harvest_definition.extraction_definition,
                       edit_path:
              pipeline_harvest_definition_extraction_definition_path(
                @pipeline,
                @harvest_definition,
                @harvest_definition.extraction_definition
              ),
                       edit_text: definition_edit_text(@harvest_definition.extraction_definition, 'extraction'),
                       jobs_path:
              pipeline_harvest_definition_extraction_definition_extraction_jobs_path(
                @pipeline,
                @harvest_definition,
                @harvest_definition.extraction_definition
              ),
                       run_sample_extraction_path:
              pipeline_harvest_definition_extraction_definition_extraction_jobs_path(
                @pipeline,
                @harvest_definition,
                @harvest_definition.extraction_definition,
                kind: :sample
              ),
                       run_full_extraction_path:
              pipeline_harvest_definition_extraction_definition_extraction_jobs_path(
                @pipeline,
                @harvest_definition,
                @harvest_definition.extraction_definition,
                kind: :full
              ),
                       delete_path:
              pipeline_harvest_definition_extraction_definition_path(
                @pipeline,
                @harvest_definition,
                @harvest_definition.extraction_definition
              )
                     } %>

        <% else %>
          <button
            type="button"
            class="card card--create-cta d-flex h-100"
            data-bs-toggle="modal"
            data-bs-target="#add-harvest-extraction">
            <div class="card-body align-items-center d-flex justify-content-center">
              <p class='card-text'>+ Add harvest extraction</p>
            </div>
            <i class="bi bi-arrow-right card__right-arrow"></i>
          </button>
        <% end %>
      </div>

      <div class='col-6'>
        <% if @harvest_definition.transformation_definition.present? %>

          <%= render partial: 'pipelines/card',
                     locals: {
                       pipeline: @pipeline,
                       block_definition: @harvest_definition,
                       definition: @harvest_definition.transformation_definition,
                       edit_path:
              pipeline_harvest_definition_transformation_definition_path(
                @pipeline,
                @harvest_definition,
                @harvest_definition.transformation_definition
              ),
                       edit_text: definition_edit_text(@harvest_definition.transformation_definition, 'transformation'),
                       jobs_path: '',
                       delete_path:
                pipeline_harvest_definition_transformation_definition_path(
                  @pipeline,
                  @harvest_definition,
                  @harvest_definition.transformation_definition
                )
                     } %>

        <% else %>
          <% disabled = !@harvest_definition&.extraction_definition&.extraction_jobs&.any?(&:completed?) %>
          <button
            type="button"
            class="<%= class_names(
                         'card', 'card--create-cta', 'd-flex', 'h-100',
                         'card--create-cta-disabled': disabled
                       ) %>"
            <% if @harvest_definition&.extraction_definition&.extraction_jobs&.any?(&:completed?) %>
              data-bs-toggle="modal"
              data-bs-target="#add-harvest-transformation"
            <% end %>>
            <div class="card-body align-items-center d-flex justify-content-center">
              <p class="card-text">+ Add harvest transformation</p>
            </div>
          </button>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<% if @pipeline.enrichments.any? %>
  <% @pipeline.enrichments.each do |enrichment_definition| %>

    <div class='card p-4 definition-group--spacer'>
      <span class='definition-group__bridge'></span>

      <div class='d-flex'>
        <div class='me-auto'>

          <%= render layout: 'shared/inline_editable_element', locals: { id: "harvest-definition-#{enrichment_definition.id}-source-id", model: enrichment_definition, attribute: :source_id, url: pipeline_harvest_definition_path(@pipeline, enrichment_definition) } do %>
            <h4><%= enrichment_definition.source_id %> </h4>
          <% end %>

          <p><%= definition_help_text(enrichment_definition, 'enrichment') %></p>
        </div>

        <div>
          <button
            type="button"
            class="btn btn-outline-danger"
            data-bs-toggle="modal"
            data-bs-target="<%= "#delete-harvest-definition-#{enrichment_definition.id}" %>">
            <i class="bi bi-trash" aria-hidden="true"></i> Delete Enrichment
          </button>
        </div>

        <%= render layout: 'shared/delete_modal',
                   locals: { path: pipeline_harvest_definition_path(@pipeline, enrichment_definition),
                             id: "delete-harvest-definition-#{enrichment_definition.id}",
                             heading_text: 'Delete Enrichment' } do %>
          <p>Are you sure you want to delete "<%= enrichment_definition.source_id %>"?</p>

          <% if enrichment_definition.extraction_definition.present? %>
            <p><%= definition_delete_text(enrichment_definition.extraction_definition, 'extraction') %></p>
          <% end %>

          <% if enrichment_definition.transformation_definition.present? %>
            <p><%= definition_delete_text(enrichment_definition.transformation_definition, 'transformation') %></p>
          <% end %>
        <% end %>
      </div>

      <div class='row'>
        <div class='col-6'>
          <% if enrichment_definition.extraction_definition.present? %>

          <%= render partial: 'pipelines/card',
                     locals: {
                       pipeline: @pipeline,
                       block_definition: enrichment_definition,
                       definition: enrichment_definition.extraction_definition,
                       edit_path:
                edit_pipeline_harvest_definition_extraction_definition_path(
                  @pipeline,
                  enrichment_definition,
                  enrichment_definition.extraction_definition
                ),
                       edit_text: definition_edit_text(enrichment_definition.extraction_definition, 'extraction'),
                       jobs_path:
                pipeline_harvest_definition_extraction_definition_extraction_jobs_path(
                  @pipeline,
                  enrichment_definition,
                  enrichment_definition.extraction_definition
                ),
                       run_sample_extraction_path:
                pipeline_harvest_definition_extraction_definition_extraction_jobs_path(
                  @pipeline,
                  enrichment_definition,
                  enrichment_definition.extraction_definition,
                  kind: :sample
                ),
                       run_full_extraction_path:
                pipeline_harvest_definition_extraction_definition_extraction_jobs_path(
                  @pipeline,
                  enrichment_definition,
                  enrichment_definition.extraction_definition,
                  kind: :full
                ),
                       delete_path:
              pipeline_harvest_definition_extraction_definition_path(
                @pipeline,
                enrichment_definition,
                enrichment_definition.extraction_definition
              )
                     } %>

          <% else %>

            <button
              type="button"
              class="card card--create-cta d-flex h-100"
              data-bs-toggle="modal"
              data-bs-target="#add-enrichment-extraction-<%= enrichment_definition.id %>">
              <div class="card-body d-flex align-items-center justify-content-center">
                <p class='card-text'>+ Add enrichment extraction</p>
              </div>
              <i class="bi bi-arrow-right card__right-arrow"></i>
            </button>

            <%= render(
                  layout: 'shared/create_modal',
                  locals: {
                    modal_heading: 'Add enrichment extraction',
                    id: "add-enrichment-extraction-#{enrichment_definition.id}",
                    modal_subheading: 'An enrichment extraction is a set of rules that ' \
                                      'define how you collect records from a content source'
                  }
                ) do %>

              <div class='d-grid mt-4'>
                <input
                  id="js-auto-complete-enrichment-extraction-definition-<%= enrichment_definition.id %>"
                  class='js-auto-complete'
                  data-src="<%= autocomplete_enrichment_extraction_definitions %>"
                  data-path="<%= "/pipelines/#{@pipeline.id}/harvest_definitions/#{enrichment_definition.id}.json" %>"
                  data-field="extraction_definition_id"
                  data-placeholder='Start typing to use an existing definition..'
                  data-key='name'>

                <div class='text-center mt-4 mb-4'>
                  or
                </div>

                <%= link_to '+ Add new extraction definition',
                            new_pipeline_harvest_definition_extraction_definition_path(
                              @pipeline,
                              enrichment_definition,
                              kind: 'enrichment'
                            ),
                            class: 'btn btn-primary' %>

              </div>
            <% end %>
          <% end %>
        </div>

        <div class='col-6'>
          <% if enrichment_definition.transformation_definition.present? %>

          <%= render partial: 'pipelines/card',
                     locals: {
                       pipeline: @pipeline,
                       block_definition: enrichment_definition,
                       definition: enrichment_definition.transformation_definition,
                       edit_path:
                pipeline_harvest_definition_transformation_definition_path(
                  @pipeline,
                  enrichment_definition,
                  enrichment_definition.transformation_definition
                ),
                       edit_text: definition_edit_text(enrichment_definition.transformation_definition,
                                                       'transformation'),
                       jobs_path: '',
                       delete_path:
                        pipeline_harvest_definition_transformation_definition_path(
                          @pipeline,
                          enrichment_definition,
                          enrichment_definition.transformation_definition
                        )
                     } %>

          <% else %>
            <button
              type="button"
              class="card mb-3 card--create-cta d-flex h-100"
              data-bs-toggle="modal"
              data-bs-target="#add-enrichment-transformation-<%= enrichment_definition.id %>">
              <div class="card-body d-flex align-items-center justify-content-center d-flex">
                <p class="card-text">+ Add enrichment transformation</p>
              </div>
            </button>

            <%= render(
                  layout: 'shared/create_modal',
                  locals: {
                    modal_heading: 'Add enrichment transformation',
                    id: "add-enrichment-transformation-#{enrichment_definition.id}",
                    modal_subheading: 'An enrichment transformation is a set of rules that defines ' \
                                      'the shape you want your enriched fragments to have'
                  }
                ) do %>
              <div class='d-grid mt-4'>
                <input
                  id="js-auto-complete-enrichment-transformation-definition-<%= enrichment_definition.id %>"
                  class='js-auto-complete'
                  data-src="<%= autocomplete_enrichment_transformation_definitions %>"
                  data-placeholder='Start typing to use an existing definition..'
                  data-path="<%= "/pipelines/#{@pipeline.id}/harvest_definitions/#{enrichment_definition.id}.json" %>"
                  data-field="transformation_definition_id"
                  data-key='name'>

                <div class='text-center mt-4 mb-4'>
                  or
                </div>

                <%= link_to '+ Add new transformation definition',
                            new_pipeline_harvest_definition_transformation_definition_path(
                              @pipeline,
                              enrichment_definition,
                              kind: 'enrichment'
                            ),
                            class: 'btn btn-primary' %>

              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
<% end %>

<% if @harvest_definition.persisted? %>
  <div class='row definition-group definition-group--spacer'>
    <span class='definition-group__bridge'></span>
    <div class='col-12'>
      <button
        type="button"
        class="card card--create-cta d-flex"
        data-bs-toggle="modal"
        data-bs-target="#add-enrichment">
        <div class="card-body align-items-center d-flex justify-content-center">
          <p class='card-text'>+ Add Enrichment</p>
        </div>
      </button>
    </div>
  </div>
<% end %>

<%# -- Modals -- %>

<%= render layout: 'shared/delete_modal', locals: { path: pipeline_path(@pipeline), heading_text: 'Delete Pipeline' } do %>
  <p>Are you sure you want to delete "<%= @pipeline.name %>"?</p>

  <% @pipeline.harvest_definitions.each do |definition| %>
    <% if definition.extraction_definition.present? %>
      <p><%= definition_delete_text(definition.extraction_definition, 'extraction') %></p>
    <% end %>

    <% if definition.transformation_definition.present? %>
      <p><%= definition_delete_text(definition.transformation_definition, 'transformation') %></p>
    <% end %>
  <% end %>
<% end %>

<%= render layout: 'shared/create_modal',
           locals: { modal_heading: 'Add harvest', id: 'add-harvest',
                     modal_subheading: 'Add a source_id to identify records from this harvest.' } do %>
  <div class='d-grid mt-4'>
    <%= vertical_form_with model: [@pipeline, @harvest_definition] do |form| %>
      <div class='row gy-3 align-items-center'>
        <%= form.hidden_field :pipeline_id, value: @pipeline.id %>
        <%= form.hidden_field :kind, value: 'harvest' %>

        <div class="col-4">
          <%= form.label :source_id, 'Source ID', class: 'form-label' %>
        </div>
        <div class='col-8'>
          <%= form.text_field :source_id,
                              class: {
                                'form-control': true,
                                'is-invalid': @harvest_definition.errors[:source_id].any?
                              } %>
        </div>
      </div>

      <div class='d-grid mt-4'>
        <button type="submit" class="btn btn-primary">Add to pipeline</button>
      </div>
    <% end %>
  </div>
<% end %>

<%= render layout: 'shared/create_modal',
           locals: { modal_heading: 'Add enrichment', id: 'add-enrichment',
                     modal_subheading: 'Add a source_id to identify records from this enrichment' } do %>
  <div class='d-grid mt-4'>
    <%= vertical_form_with model: [@pipeline, @enrichment_definition] do |form| %>
      <div class='row gy-3 align-items-center'>
        <%= form.hidden_field :pipeline_id, value: @pipeline.id %>
        <%= form.hidden_field :kind, value: 'enrichment' %>
        <%= form.hidden_field :priority, value: "-#{@pipeline.enrichments.count + 1}" %>

        <div class="col-4">
          <%= form.label :source_id, 'Source ID', class: 'form-label' %>
        </div>
        <div class='col-8'>
          <%= form.text_field :source_id,
                              class: {
                                'form-control': true,
                                'is-invalid': @enrichment_definition.errors[:source_id].any?
                              } %>
        </div>
      </div>

      <div class='d-grid mt-4'>
        <button type="submit" class="btn btn-primary">Add to pipeline</button>
      </div>
    <% end %>
  </div>
<% end %>

<% if @harvest_definition.persisted? %>
  <%= render(
        layout: 'shared/create_modal',
        locals: {
          modal_heading: 'Add harvest extraction',
          id: 'add-harvest-extraction',
          modal_subheading:
            'A harvest extraction is a set of rules that define how you collect records from a content source'
        }
      ) do %>

    <div class='d-grid mt-4'>
      <input
        id="js-auto-complete-extraction-definition"
        class='js-auto-complete'
        data-src="<%= autocomplete_harvest_extraction_definitions %>"
        data-path="<%= "/pipelines/#{@pipeline.id}/harvest_definitions/#{@harvest_definition.id}.json" %>"
        data-field="extraction_definition_id"
        data-placeholder='Start typing to use an existing definition..'
        data-key='name'>

      <div class='text-center mt-4 mb-4'>
        or
      </div>

      <%= link_to '+ Add new extraction definition',
                  new_pipeline_harvest_definition_extraction_definition_path(
                    @pipeline,
                    @harvest_definition,
                    kind: 'harvest'
                  ),
                  class: 'btn btn-primary' %>
    </div>
  <% end %>

  <%= render(
        layout: 'shared/create_modal',
        locals: {
          modal_heading: 'Add harvest transformation',
          id: 'add-harvest-transformation',
          modal_subheading:
            'A harvest transformation is a set of rules that defines the shape you want your harvested records to have'
        }
      ) do %>
    <div class='d-grid mt-4'>
      <input
        id="js-auto-complete-transformation-definition"
        class='js-auto-complete'
        data-src="<%= autocomplete_harvest_transformation_definitions %>"
        data-placeholder='Start typing to use an existing definition..'
        data-path="<%= "/pipelines/#{@pipeline.id}/harvest_definitions/#{@harvest_definition.id}.json" %>"
        data-field="transformation_definition_id"
        data-key='name'>

      <div class='text-center mt-4 mb-4'>
        or
      </div>

      <%= link_to '+ Add new transformation definition',
                  new_pipeline_harvest_definition_transformation_definition_path(
                    @pipeline,
                    @harvest_definition,
                    kind: 'harvest'
                  ),
                  class: 'btn btn-primary' %>
    </div>
  <% end %>
<% end %>

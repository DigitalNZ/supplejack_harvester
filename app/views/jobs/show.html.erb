<%= render 'shared/breadcrumb_nav' %>

<div class="float-start">
  <h1><%= @job.updated_at.strftime('%d %b | %H:%M | ') %> Dan Charles</h1>
  <h2 class="text-success"><%= job_status_text(@job) %></h2>
</div>

<div class="float-end">
  <% if @job.queued? || @job.running? %>
    <% cancel_path = cancel_content_partner_extraction_definition_job_path(@content_partner, @extraction_definition, @job) %>
    <%= button_to "Cancel job", cancel_path, class: "btn btn-outline-danger me-1", form_class: 'd-inline' %>
  <% end %>
  <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#delete-modal">Delete results</button>
</div>

<div class="clearfix"></div>

<% path = content_partner_extraction_definition_job_path(@content_partner, @extraction_definition, @job)%>
<%= render layout: 'shared/delete-modal', locals: { path: } do %>
  <p>Are you sure you want to delete this job?</p>
  <p>It will delete all the data related to it.</p>
<% end %>

<div class="alert alert-success border-success text-dark">
  <h4 class="alert-heading">This job is currently <%= @job.status %></h4>
  <p>
    It has been running for XX mins.
    This is some more information about what you can currently do while the job is running,
    and some ways you may be able to pass your time.
  </p>
</div>

<% if @document.blank? %>
  <p>The extracted page could not be found.</p>
<% else %>

<ul class="nav nav-tabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#result-tab" type="button" role="tab" aria-controls="result-tab" aria-selected="true">Result</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#request-headers-tab" type="button" role="tab" aria-controls="request-headers-tab" aria-selected="false">Request Headers</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#response-headers-tab" type="button" role="tab" aria-controls="response-headers-tab" aria-selected="false">Response Headers</button>
  </li>
</ul>
<div class="tab-content">
  <div class="tab-pane fade show active" id="result-tab" role="tal" aria-labelledby="result-tab" tabindex="0">
    <div class="col-12 mt-3">
      <pre class="bg-dark text-white p-1 extraction-result-viewer"><code><%= JSON.pretty_generate(JSON.parse(@document.body)) %></code></pre>
    </div>
  </div>
  <div class="tab-pane fade" id="request-headers-tab" role="tal" aria-labelledby="request-headers-tab" tabindex="0">
    <ol class="list-group">
      <li class="list-group-item d-flex justify-content-between align-items-start">
        <div class="ms-2 me-auto">
          <div class="fw-bold">URL</div>
          <a href="<%= @document.url %>"><%= @document.url %></a>
        </div>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-start">
        <div class="ms-2 me-auto">
          <div class="fw-bold">HTTP Method</div>
          <%= @document.method %>
        </div>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-start">
        <div class="ms-2 me-auto">
          <div class="fw-bold">Params</div>
          <pre><code><%= JSON.pretty_generate(@document.params) %></code></pre>
        </div>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-start">
        <div class="ms-2 me-auto">
          <div class="fw-bold">Request Headers</div>
          <% @document.request_headers.each do |header, value| %>
              <dt class="d-inline"><%= header %></dt>
              <dd class="d-inline"><%= value %></dd>
              <br />
            <% end %>
        </div>
      </li>
    </ol>
  </div>
  <div class="tab-pane fade" id="response-headers-tab" role="tal" aria-labelledby="response-headers-tab" tabindex="0">
    <ol class="list-group">
      <li class="list-group-item d-flex justify-content-between align-items-start">
        <div class="ms-2 me-auto">
          <div class="fw-bold">Status code</div>
          <%= @document.status %>
        </div>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-start">
        <div class="ms-2 me-auto">
          <div class="fw-bold">Response Headers</div>
            <% @document.response_headers.each do |header, value| %>
              <dt class="d-inline"><%= header %></dt>
              <dd class="d-inline"><%= value %></dd>
              <br />
            <% end %>
          </dl>
        </div>
      </li>
    </ol>
  </div>
</div>

<%= render 'shared/pagination_below_table', items: @documents %>

<% end %>
